

MERGE INTO MARKET_INSIGHTS AS DW
USING (
    SELECT 
        S.TIMESTAMP,
        S.OPEN,
        S.HIGH,
        S.LOW,
        S.CLOSE,
        S.VOLUME,
        SA.POLARITY,
        SA.COMPOUND,
        SA.POS,
        SA.NEU,
        SA.NEG,
        SA.POSITIVE_KEYWORDS,
        SA.NEGATIVE_KEYWORDS
    FROM {{ ref('STOCK_DM') }} AS S
    JOIN {{ ref('SENTIMENT_ANALYSIS') }} AS SA
        ON S.TIMESTAMP = SA.DATE
    WHERE S.TIMESTAMP >= CURRENT_DATE - 2
      AND SA.DATE >= CURRENT_DATE - 2
) AS SRC
ON DW.TIMESTAMP = SRC.TIMESTAMP
WHEN NOT MATCHED THEN
    INSERT (
        TIMESTAMP, OPEN, HIGH, LOW, CLOSE, VOLUME,
        POLARITY, COMPOUND, POS, NEU, NEG,
        POSITIVE_KEYWORDS, NEGATIVE_KEYWORDS
    )
    VALUES (
        SRC.TIMESTAMP, SRC.OPEN, SRC.HIGH, SRC.LOW, SRC.CLOSE, SRC.VOLUME,
        SRC.POLARITY, SRC.COMPOUND, SRC.POS, SRC.NEU, SRC.NEG,
        SRC.POSITIVE_KEYWORDS, SRC.NEGATIVE_KEYWORDS
    );

{% endmacro %}
